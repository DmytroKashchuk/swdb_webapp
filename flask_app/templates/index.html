{% extends "base.html" %}

{% block title %}SWDB Query Explorer{% endblock %}

{% block extra_head %}
	<style>
		.query-card {
			max-width: 960px;
			margin: 0 auto 1.5rem;
			box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.08);
		}

		.query-input {
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
				"Liberation Mono", "Courier New", monospace;
			font-size: 0.9rem;
			min-height: 5rem;
		}

		.table-container {
			width: 100%;
			max-width: 100%;
			margin: 0 auto;
		}

		/* Tabulator tweaks for many columns */
		#data-table-wrapper {
			width: 100%;
		}

		#data-table-top-scroll {
			width: 100%;
			overflow-x: auto;
			overflow-y: hidden;
			margin-bottom: 0;
			border: 1px solid #dee2e6;
			border-bottom: none;
			background: #f8f9fa;
			display: none; /* Will be shown via JS when needed */
		}

		#data-table-top-scroll-inner {
			height: 1px;
			/* Width will be set dynamically by JavaScript */
		}

		/* Hide the bottom scroll since we don't need it */
		#data-table-bottom-scroll {
			display: none;
		}

		/* Style the scrollbar for better visibility */
		#data-table-top-scroll::-webkit-scrollbar {
			height: 12px;
		}

		#data-table-top-scroll::-webkit-scrollbar-track {
			background: #f1f1f1;
		}

		#data-table-top-scroll::-webkit-scrollbar-thumb {
			background: #888;
			border-radius: 6px;
		}

		#data-table-top-scroll::-webkit-scrollbar-thumb:hover {
			background: #555;
		}

		#data-table {
			min-width: 100%;
		}

		.tabulator .tabulator-header .tabulator-col {
			white-space: nowrap;
			font-size: 0.75rem;
		}

		.tabulator .tabulator-row .tabulator-cell {
			white-space: nowrap;
			font-size: 0.75rem;
		}

		.tabulator {
			border-radius: 0.25rem;
			border: 1px solid #dee2e6;
		}

		/* Ensure the table header is visible when top scroll is shown */
		#data-table-wrapper .tabulator {
			border-top-left-radius: 0;
			border-top-right-radius: 0;
		}

		#data-table-top-scroll:not([style*="display: none"]) + #data-table-wrapper .tabulator {
			border-top: none;
		}
	</style>
{% endblock %}

{% block content %}
	<header class="mb-4 text-center">
		<h1 class="h3 mb-1">Structured Web Data Browser</h1>
		<p class="text-muted mb-0">
			Run readâ€‘only SQL queries against the SWDB PostgreSQL database and
			explore the results below.
		</p>
	</header>

		<section class="query-card card">
			<div class="card-body">
				<form id="query-form" class="text-center">
					<label for="sql-input" class="form-label fw-semibold">
						SQL query
					</label>
					<textarea
						id="sql-input"
						name="sql"
						class="form-control query-input mb-3 mx-auto"
						style="max-width: 100%;"
					>{{ example_query }}</textarea>

					<div class="d-flex justify-content-center align-items-center gap-2">
						<button type="submit" class="btn btn-primary px-4">
							Run query
						</button>
						<span id="status-text" class="text-muted small"></span>
					</div>
				</form>
			</div>
		</section>

		<section class="table-container">
			<div class="d-flex justify-content-between align-items-center mb-2">
				<h2 class="h6 mb-0">Result preview</h2>
				<div class="d-flex align-items-center gap-2">
					<button type="button" class="btn btn-outline-secondary btn-sm" id="customize-columns-btn" data-bs-toggle="modal" data-bs-target="#columnsModal" disabled>
						Customize Columns
					</button>
					<button type="button" class="btn btn-outline-success btn-sm" id="export-csv-btn" disabled>
						Export to CSV
					</button>
					<span id="row-count" class="text-muted small"></span>
				</div>
			</div>
			<div id="data-table-top-scroll">
				<div id="data-table-top-scroll-inner"></div>
			</div>
			<div id="data-table-wrapper">
				<div id="data-table"></div>
			</div>
			<div id="data-table-bottom-scroll">
				<div id="data-table-bottom-scroll-inner"></div>
			</div>
		</section>

		<!-- Modal for column selection -->
		<div class="modal fade" id="columnsModal" tabindex="-1" aria-labelledby="columnsModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-scrollable">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="columnsModalLabel">Select Columns to Display</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="mb-3">
							<button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-cols">Select All</button>
							<button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all-cols">Deselect All</button>
						</div>
						<div id="columns-checkbox-container" class="row g-2">
							<!-- Checkboxes will be injected here -->
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	{% endblock %}

	{% block extra_scripts %}
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

		<script>
			let table = null;

			function updateColumnSelectionUI(allColumns) {
				const container = document.getElementById("columns-checkbox-container");
				container.innerHTML = "";
				
				// Sort columns alphabetically
				const sortedCols = Array.from(allColumns).sort();

				sortedCols.forEach(col => {
					const colDiv = document.createElement("div");
					colDiv.className = "col-md-4 col-sm-6";
					
					const formCheck = document.createElement("div");
					formCheck.className = "form-check";
					
					const input = document.createElement("input");
					input.className = "form-check-input column-toggle";
					input.type = "checkbox";
					input.value = col;
					input.id = `col-check-${col}`;
					input.checked = true; // Default to checked

					input.addEventListener("change", function() {
						const isVisible = this.checked;
						const field = this.value;
						if (table) {
							if (isVisible) {
								table.showColumn(field);
							} else {
								table.hideColumn(field);
							}
						}
					});

					const label = document.createElement("label");
					label.className = "form-check-label small text-break";
					label.htmlFor = `col-check-${col}`;
					label.textContent = col;

					formCheck.appendChild(input);
					formCheck.appendChild(label);
					colDiv.appendChild(formCheck);
					container.appendChild(colDiv);
				});

				document.getElementById("customize-columns-btn").disabled = false;
				document.getElementById("export-csv-btn").disabled = false;
			}

			document.getElementById("select-all-cols").addEventListener("click", function() {
				document.querySelectorAll(".column-toggle").forEach(cb => {
					cb.checked = true;
					cb.dispatchEvent(new Event("change"));
				});
			});

			document.getElementById("deselect-all-cols").addEventListener("click", function() {
				document.querySelectorAll(".column-toggle").forEach(cb => {
					cb.checked = false;
					cb.dispatchEvent(new Event("change"));
				});
			});

			document.getElementById("export-csv-btn").addEventListener("click", function() {
				if (table) {
					table.download("csv", "query_results.csv");
				}
			});

			function buildColumns(columns) {
				return columns.map((name) => ({
					title: name,
					field: name,
					headerSort: false,
					widthShrink: 8,
				}));
			}

			// Function to set up synchronized scrolling between top scroll bar and table
			function setupSynchronizedScrolling() {
				const topScroll = document.getElementById("data-table-top-scroll");
				const topScrollInner = document.getElementById("data-table-top-scroll-inner");
				const tableHolder = document.querySelector("#data-table .tabulator-tableholder");
				
				if (!tableHolder) return;
				
				// Set the inner width to match the table's scrollable content
				const updateScrollWidth = () => {
					const tableWidth = tableHolder.scrollWidth;
					topScrollInner.style.width = tableWidth + "px";
					// Show top scroll only when content overflows
					topScroll.style.display = tableHolder.scrollWidth > tableHolder.clientWidth ? "block" : "none";
				};
				
				// Initial setup
				updateScrollWidth();
				
				// Synchronize scrolling between top bar and table
				let isSyncing = false;
				
				topScroll.addEventListener("scroll", () => {
					if (!isSyncing) {
						isSyncing = true;
						tableHolder.scrollLeft = topScroll.scrollLeft;
						isSyncing = false;
					}
				});
				
				tableHolder.addEventListener("scroll", () => {
					if (!isSyncing) {
						isSyncing = true;
						topScroll.scrollLeft = tableHolder.scrollLeft;
						isSyncing = false;
					}
				});
				
				// Update width when table is redrawn
				if (table) {
					table.on("tableBuilt", updateScrollWidth);
					table.on("dataLoaded", updateScrollWidth);
					table.on("columnResized", updateScrollWidth);
					
					// Also update on window resize
					window.addEventListener("resize", updateScrollWidth);
				}
			}

			function createOrUpdateTable(columns, rows) {
				const tableElement = document.getElementById("data-table");

				const options = {
					data: rows,
					columns: buildColumns(columns),
					layout: "fitDataStretch", // full width, horizontal scroll when needed
					height: "600px",
					placeholder: "Run a query to see results here.",
					pagination: true,
					paginationSize: 25,
					movableColumns: true,
					resizableColumns: true,
				};

				if (table) {
					table.setColumns(options.columns);
					table.setData(options.data);
				} else {
					table = new Tabulator(tableElement, options);
				}

				updateColumnSelectionUI(columns);
				
				// Set up synchronized scrolling after table is created/updated
				// Use setTimeout to ensure DOM is fully updated
				setTimeout(setupSynchronizedScrolling, 100);
			}

			async function submitQuery(event) {
				event.preventDefault();
				const sql = document.getElementById("sql-input").value;
				const statusEl = document.getElementById("status-text");
				const rowCountEl = document.getElementById("row-count");
				statusEl.textContent = "Running query...";
				rowCountEl.textContent = "";

				try {
					const response = await axios.post("/api/query", { sql });
					const { columns, rows } = response.data;

					createOrUpdateTable(columns || [], rows || []);

					const count = rows ? rows.length : 0;
					rowCountEl.textContent = count
						? `${count} row${count === 1 ? "" : "s"} returned`
						: "No rows returned";
					statusEl.textContent = "Query completed.";
					statusEl.classList.remove("text-danger");
				} catch (error) {
					console.error(error);
					const message =
						(error.response && error.response.data && error.response.data.error) ||
						error.message ||
						"Unexpected error";
					statusEl.textContent = message;
					statusEl.classList.add("text-danger");
				}
			}

			document
				.getElementById("query-form")
				.addEventListener("submit", submitQuery);

			// Run initial example query on load for faster feedback
			window.addEventListener("load", () => {
				const sql = document.getElementById("sql-input").value.trim();
				if (sql) {
					document.getElementById("query-form").dispatchEvent(new Event("submit"));
				}
			});
	</script>
{% endblock %}